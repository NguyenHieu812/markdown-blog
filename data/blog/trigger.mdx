---
title: 'Trigger - Kh√°i ni·ªám v√† V√≠ d·ª•'
date: '2025-01-31'
lastmod: '2025-01-31'
tags: ['sql', 'guide', 'trigger', 'blog']
draft: false
summary: 'N·∫øu b·∫°n ƒë√£ nghe v·ªÅ Trigger nhi·ªÅu m√† v·∫´n ch∆∞a bi·∫øt c√°ch d√πng ho·∫∑c ƒëang mu·ªën t√¨m hi·ªÉu v·ªÅ n√≥, th√¨ h√¥m nay, h√£y ƒë·ªÉ m√¨nh gi√∫p c√°c b·∫°n hi·ªÉu r√µ h∆°n v·ªÅ kh√°i ni·ªám **Trigger**.'
---

## Gi·ªõi thi·ªáu

Khi thao t√°c v·ªõi c∆° s·ªü d·ªØ li·ªáu, c√≥ nhi·ªÅu tr∆∞·ªùng h·ª£p c·∫ßn **t·ª± ƒë·ªông h√≥a** m·ªôt s·ª± ki·ªán ho·∫∑c theo d√µi m·ªôt s·ª± thay ƒë·ªïi ƒë·ªÉ k√≠ch ho·∫°t m·ªôt h√†nh ƒë·ªông kh√°c. **Trigger** ƒë∆∞·ª£c t·∫°o ra ƒë·ªÉ ƒë·∫£m nh·∫≠n c√¥ng vi·ªác n√†y.

## Trigger l√† g√¨?

Trigger l√† m·ªôt **ƒë·ªëi t∆∞·ª£ng trong c∆° s·ªü d·ªØ li·ªáu**, ho·∫°t ƒë·ªông nh∆∞ m·ªôt th·ªß t·ª•c ƒë∆∞·ª£c th·ª±c thi t·ª± ƒë·ªông khi m·ªôt s·ª± ki·ªán c·ª• th·ªÉ x·∫£y ra tr√™n m·ªôt b·∫£ng. Trigger th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ:

- **Duy tr√¨ t√≠nh to√†n v·∫πn d·ªØ li·ªáu**
- **Ki·ªÉm tra r√†ng bu·ªôc**
- **Th·ª±c hi·ªán c√°c thao t√°c t·ª± ƒë·ªông** khi c√≥ thay ƒë·ªïi trong b·∫£ng d·ªØ li·ªáu

## Ph√¢n lo·∫°i Trigger

C√≥ hai lo·∫°i Trigger ph·ªï bi·∫øn:

- **BEFORE Trigger**: K√≠ch ho·∫°t **tr∆∞·ªõc** khi s·ª± ki·ªán x·∫£y ra.
- **AFTER Trigger**: K√≠ch ho·∫°t **sau** khi s·ª± ki·ªán x·∫£y ra.

Ngo√†i ra, m·ªôt s·ªë h·ªá qu·∫£n tr·ªã CSDL nh∆∞ **SQL Server** c√≤n c√≥ **INSTEAD OF Trigger**, gi√∫p thay th·∫ø thao t√°c `INSERT`, `UPDATE` ho·∫∑c `DELETE`.

## V√≠ d·ª• v·ªÅ Trigger

### V√≠ d·ª• 1: Ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi ch√®n (`BEFORE INSERT`)

Gi·∫£ s·ª≠ ta c√≥ b·∫£ng `Customer` v√† c·∫ßn ki·ªÉm tra tu·ªïi kh√°ch h√†ng ph·∫£i **l·ªõn h∆°n 18** th√¨ m·ªõi ƒë∆∞·ª£c th√™m v√†o:

```sql
CREATE TRIGGER before_insert_customer
BEFORE INSERT ON Customer
FOR EACH ROW
BEGIN
    IF NEW.age < 18 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Tu·ªïi kh√°ch h√†ng kh√¥ng ƒë∆∞·ª£c d∆∞·ªõi 18';
    END IF;
END;
```

**Gi·∫£i th√≠ch:**

- `BEFORE INSERT ON Customer`: K√≠ch ho·∫°t tr∆∞·ªõc khi c√≥ m·ªôt b·∫£n ghi m·ªõi ƒë∆∞·ª£c ch√®n v√†o b·∫£ng `Customer`.
- `NEW.age`: Gi√° tr·ªã tu·ªïi c·ªßa kh√°ch h√†ng.
- `SIGNAL SQLSTATE '45000'`: B√°o l·ªói n·∫øu ƒëi·ªÅu ki·ªán kh√¥ng th·ªèa m√£n.

### V√≠ d·ª• 2: Ghi log thay ƒë·ªïi d·ªØ li·ªáu (`AFTER UPDATE`)

V√≠ d·ª• n√†y gi√∫p theo d√µi s·ª± thay ƒë·ªïi d·ªØ li·ªáu trong b·∫£ng `Employees` b·∫±ng c√°ch l∆∞u l·∫°i l·ªãch s·ª≠ c·∫≠p nh·∫≠t v√†o b·∫£ng `log_data`.

#### T·∫°o b·∫£ng log d·ªØ li·ªáu:

```sql
CREATE TABLE log_data (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50),
    record_id INT,
    column_name VARCHAR(50),
    old_value TEXT,
    new_value TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### T·∫°o b·∫£ng `Employees`:

```sql
CREATE TABLE employees (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    salary DECIMAL(10,2),
    department VARCHAR(50)
);
```

#### T·∫°o Trigger theo d√µi thay ƒë·ªïi d·ªØ li·ªáu:

```sql
CREATE TRIGGER after_employee_update
AFTER UPDATE ON employees
FOR EACH ROW
BEGIN
    -- Ghi l·∫°i thay ƒë·ªïi c·ªßa c·ªôt name
    IF OLD.name <> NEW.name THEN
        INSERT INTO log_data (table_name, record_id, column_name, old_value, new_value, updated_at)
        VALUES ('employees', OLD.id, 'name', OLD.name, NEW.name, NOW());
    END IF;

    -- Ghi l·∫°i thay ƒë·ªïi c·ªßa c·ªôt salary
    IF OLD.salary <> NEW.salary THEN
        INSERT INTO log_data (table_name, record_id, column_name, old_value, new_value, updated_at)
        VALUES ('employees', OLD.id, 'salary', OLD.salary, NEW.salary, NOW());
    END IF;

    -- Ghi l·∫°i thay ƒë·ªïi c·ªßa c·ªôt department
    IF OLD.department <> NEW.department THEN
        INSERT INTO log_data (table_name, record_id, column_name, old_value, new_value, updated_at)
        VALUES ('employees', OLD.id, 'department', OLD.department, NEW.department, NOW());
    END IF;
END;
```

### Gi·∫£i th√≠ch:

- `AFTER UPDATE`: Trigger ch·∫°y sau khi c·∫≠p nh·∫≠t d·ªØ li·ªáu.
- `FOR EACH ROW`: M·ªói b·∫£n ghi ƒë∆∞·ª£c c·∫≠p nh·∫≠t s·∫Ω k√≠ch ho·∫°t trigger.
- `OLD` & `NEW`:
  - `OLD.column_name`: Gi√° tr·ªã tr∆∞·ªõc khi c·∫≠p nh·∫≠t.
  - `NEW.column_name`: Gi√° tr·ªã sau khi c·∫≠p nh·∫≠t.
- **ƒêi·ªÅu ki·ªán ki·ªÉm tra thay ƒë·ªïi d·ªØ li·ªáu**:
  - N·∫øu gi√° tr·ªã thay ƒë·ªïi (`IF OLD.value <> NEW.value`) th√¨ m·ªõi ghi log ƒë·ªÉ tr√°nh l√£ng ph√≠ t√†i nguy√™n.

Sau khi t·∫°o th√†nh c√¥ng Trigger, b·∫°n c√≥ th·ªÉ th·ª≠ c·∫≠p nh·∫≠t d·ªØ li·ªáu trong b·∫£ng `Employees` v√† ki·ªÉm tra b·∫£ng `log_data` ƒë·ªÉ xem log thay ƒë·ªïi.

> Note: H·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu kh√°c nhau c√≥ th·ªÉ c√≥ c√°ch s·ª≠ d·ª•ng Trigger kh√°c nhau, b·∫°n n√™n tham kh·∫£o t√†i li·ªáu ch√≠nh th·ª©c c·ªßa h·ªá qu·∫£n tr·ªã CSDL m√† b·∫°n ƒëang s·ª≠ d·ª•ng.

## K·∫øt lu·∫≠n

B√†i vi·∫øt n√†y gi√∫p b·∫°n hi·ªÉu r√µ h∆°n v·ªÅ **Trigger**, c√°ch s·ª≠ d·ª•ng n√≥ trong CSDL, v√† cung c·∫•p c√°c v√≠ d·ª• th·ª±c t·∫ø. N·∫øu b·∫°n mu·ªën t√¨m hi·ªÉu s√¢u h∆°n, h√£y tham kh·∫£o th√™m t√†i li·ªáu tr√™n internet ho·∫∑c li√™n h·ªá m√¨nh qua email: [tronghieu12802@gmail.com](mailto:tronghieu12802@gmail.com).

C·∫£m ∆°n b·∫°n ƒë√£ d√†nh th·ªùi gian ƒë·ªçc b√†i vi·∫øt! üöÄ
